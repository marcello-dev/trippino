<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Profile - Trippino</title>
    <link
      rel="icon"
      type="image/png"
      href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGNgYAAAAAMAASsJTYQAAAAASUVORK5CYII="
    />
    <style>
      :root {
        --bg: #f6f8fa;
        --card: #ffffff;
        --muted: #8a5a32;
        --primary: #f97316;
      }
      body {
        font-family:
          Inter,
          system-ui,
          -apple-system,
          "Segoe UI",
          Roboto,
          "Helvetica Neue",
          Arial;
        background: var(--bg);
        margin: 0;
        padding: 24px;
        color: #111;
      }
      .app {
        max-width: 980px;
        margin: 0 auto;
      }
      .topnav {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 18px;
      }
      .topnav .brand {
        font-size: 20px;
        font-weight: 700;
        color: inherit;
        text-decoration: none;
      }
      .card {
        background: var(--card);
        padding: 14px;
        border-radius: 12px;
        box-shadow: 0 6px 18px rgba(12, 18, 32, 0.06);
        margin-bottom: 12px;
      }
      .small {
        font-size: 12px;
        color: var(--muted);
      }
      .menu-item:hover {
        background: #f6f6f6;
        border-radius: 6px;
      }
      .btn {
        padding: 8px 10px;
        border-radius: 8px;
        border: 0;
        cursor: pointer;
      }
      .btn.primary {
        background: var(--primary);
        color: white;
      }
      .btn.ghost {
        background: transparent;
        border: 1px solid #ddd;
      }
      input[type="password"] {
        padding: 8px 10px;
        border: 1px solid #ddd;
        border-radius: 6px;
        width: 100%;
        box-sizing: border-box;
        margin-bottom: 8px;
      }
      label {
        display: block;
        margin-bottom: 4px;
        font-size: 14px;
        font-weight: 600;
      }
      .form-group {
        margin-bottom: 16px;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <header class="topnav">
        <a href="index.html" class="brand">Trippino</a>
        <div
          style="
            margin-left: auto;
            display: flex;
            gap: 8px;
            align-items: center;
          "
        >
          <div id="authArea"></div>
          <div id="burgerWrapper" style="position: relative; margin-left: 8px">
            <button id="burgerBtn" aria-label="Open menu" class="btn ghost">
              â˜°
            </button>
            <div
              id="burgerMenu"
              style="
                display: none;
                position: absolute;
                right: 0;
                top: 40px;
                background: var(--card);
                border: 1px solid #eee;
                border-radius: 8px;
                box-shadow: 0 6px 18px rgba(12, 18, 32, 0.06);
                z-index: 1000;
                min-width: 160px;
                padding: 6px;
              "
            >
              <div
                class="small menu-item"
                data-action="home"
                style="padding: 8px; cursor: pointer"
              >
                Home
              </div>
              <div
                class="small menu-item"
                data-action="profile"
                style="padding: 8px; cursor: pointer"
              >
                Profile
              </div>
              <div
                class="small menu-item"
                data-action="about"
                style="padding: 8px; cursor: pointer"
              >
                About
              </div>
              <div
                class="small menu-item"
                data-action="logout"
                style="padding: 8px; cursor: pointer"
              >
                Logout
              </div>
            </div>
          </div>
        </div>
      </header>

      <div class="card">
        <h2>Profile</h2>
        <div id="profileInfo" style="margin-top: 12px">
          <div class="small" style="color: var(--muted)">Loading...</div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin-top: 0">Change Password</h3>
        <form id="changePasswordForm">
          <div class="form-group">
            <label for="currentPassword">Current Password</label>
            <input
              type="password"
              id="currentPassword"
              placeholder="Enter current password"
              required
            />
          </div>
          <div class="form-group">
            <label for="newPassword">New Password</label>
            <input
              type="password"
              id="newPassword"
              placeholder="Enter new password"
              required
              minlength="6"
            />
          </div>
          <div class="form-group">
            <label for="confirmPassword">Confirm New Password</label>
            <input
              type="password"
              id="confirmPassword"
              placeholder="Confirm new password"
              required
            />
          </div>
          <button type="submit" class="btn primary">Update Password</button>
          <div
            id="passwordMessage"
            style="margin-top: 8px; font-size: 14px"
          ></div>
        </form>
      </div>
    </div>

    <script src="/config.js"></script>
    <script type="module">
      import { getCsrfToken } from "/modules/csrf.js";
      import { getCurrentUser, logout } from "/modules/auth.js";

      // reuse small auth logic similar to index/trip pages
      const API_BASE = window.APP_CONFIG.API_BASE;
      const authArea = document.getElementById("authArea");
      let currentUser = null;

      async function checkAuth() {
        try {
          const user = await getCurrentUser();
          if (!user) {
            setAnonymous();
            return null;
          }
          setAuthenticated(user);
          return user;
        } catch (e) {
          setAnonymous();
          return null;
        }
      }

      function setAnonymous() {
        currentUser = null;
        authArea.innerHTML = `<button id="goAuthBtn" class="btn primary">Sign in / Register</button>`;
        document
          .getElementById("goAuthBtn")
          .addEventListener(
            "click",
            () => (window.location.href = "auth.html"),
          );
        const burgerBtn = document.getElementById("burgerBtn");
        if (burgerBtn) burgerBtn.style.display = "none";
      }

      function setAuthenticated(user) {
        currentUser = user;
        authArea.innerHTML = "";
        const burgerBtn = document.getElementById("burgerBtn");
        if (burgerBtn) burgerBtn.style.display = "";

        const menu = document.getElementById("burgerMenu");
        if (menu) {
          menu.querySelectorAll(".menu-item").forEach((mi) =>
            mi.addEventListener("click", async () => {
              const act = mi.dataset.action;
              if (act === "logout") {
                localStorage.clear();
                await logout();
                window.location.href = "index.html";
              } else if (act === "profile")
                window.location.href = "profile.html";
              else if (act === "about") window.location.href = "about.html";
              else if (act === "home") window.location.href = "index.html";
              menu.style.display = "none";
            }),
          );
        }

        // Display user info
        displayUserInfo(user);
      }

      function displayUserInfo(user) {
        const profileInfo = document.getElementById("profileInfo");
        if (!profileInfo) return;

        profileInfo.innerHTML = `
        <div style="margin-bottom:8px">
          <strong>Email:</strong> ${escapeHtml(user.email)}
        </div>
        <div class="small" style="color:var(--muted)">
          Account created: ${user.created_at ? new Date(user.created_at).toLocaleDateString() : "N/A"}
        </div>
      `;
      }

      function escapeHtml(s) {
        return String(s).replace(/[&<>"']/g, function (ch) {
          return {
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#39;",
          }[ch];
        });
      }

      async function changePassword(currentPassword, newPassword) {
        try {
          const token = await getCsrfToken();
          const res = await fetch(`${API_BASE}/api/change-password`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "CSRF-Token": token,
            },
            credentials: "include",
            body: JSON.stringify({ currentPassword, newPassword }),
          });

          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.error || "Password change failed");
          }

          return { success: true };
        } catch (e) {
          throw e;
        }
      }

      function setupBurgerMenu() {
        document.addEventListener("click", (e) => {
          if (!e.target.closest("#burgerWrapper"))
            document.getElementById("burgerMenu").style.display = "none";
        });
        const b = document.getElementById("burgerBtn"),
          m = document.getElementById("burgerMenu");
        if (b && m)
          b.addEventListener("click", (e) => {
            e.stopPropagation();
            m.style.display = m.style.display === "none" ? "" : "none";
          });
      }

      setupBurgerMenu();
      // Kick off auth check (module ensures imports are ready)
      checkAuth();

      // Handle password change form
      document
        .getElementById("changePasswordForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const currentPassword =
            document.getElementById("currentPassword").value;
          const newPassword = document.getElementById("newPassword").value;
          const confirmPassword =
            document.getElementById("confirmPassword").value;
          const messageEl = document.getElementById("passwordMessage");

          // Clear previous message
          messageEl.textContent = "";
          messageEl.style.color = "";

          // Validate passwords match
          if (newPassword !== confirmPassword) {
            messageEl.textContent = "New passwords do not match";
            messageEl.style.color = "red";
            return;
          }

          // Validate password length
          if (newPassword.length < 6) {
            messageEl.textContent = "Password must be at least 6 characters";
            messageEl.style.color = "red";
            return;
          }

          try {
            await changePassword(currentPassword, newPassword);
            messageEl.textContent = "Password changed successfully!";
            messageEl.style.color = "green";

            // Clear form
            document.getElementById("changePasswordForm").reset();
          } catch (err) {
            messageEl.textContent = err.message || "Failed to change password";
            messageEl.style.color = "red";
          }
        });
    </script>
  </body>
</html>
