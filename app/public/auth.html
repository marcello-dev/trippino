<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Sign in — Trippino</title>
    <style>
      :root {
        --bg: #f6f8fa;
        --card: #fff;
        --muted: #8a5a32;
        --primary: #f97316;
        --accent: #ffb380;
      }

      body {
        font-family:
          Inter,
          system-ui,
          -apple-system,
          "Segoe UI",
          Roboto,
          "Helvetica Neue",
          Arial;
        background: var(--bg);
        margin: 0;
        padding: 10px;
        color: #111;
      }

      .app {
        max-width: 480px;
        margin: 40px auto;
      }

      .card {
        background: var(--card);
        padding: 18px;
        border-radius: 12px;
        box-shadow: 0 6px 18px rgba(12, 18, 32, 0.06);
      }

      h1 {
        margin: 0 0 12px 0;
        font-size: 20px;
      }

      .small {
        font-size: 13px;
        color: var(--muted);
      }

      input {
        width: 100%;
        box-sizing: border-box;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        margin-top: 8px;
      }

      .row {
        display: flex;
        gap: 8px;
        margin-top: 12px;
      }

      .btn {
        padding: 8px 12px;
        border-radius: 8px;
        border: 0;
        cursor: pointer;
      }

      .btn.primary {
        background: var(--primary);
        color: #fff;
      }

      .btn.ghost {
        background: transparent;
        border: 1px solid #ddd;
      }

      .note {
        margin-top: 12px;
        color: var(--muted);
        font-size: 13px;
      }

      .error {
        color: #b91c1c;
        margin-top: 8px;
      }

      footer {
        margin-top: 48px;
        padding: 24px 0;
        border-top: 1px solid #e5e7eb;
        text-align: center;
        color: var(--muted);
        font-size: 14px;
      }

      footer a {
        color: var(--primary);
        text-decoration: none;
      }

      footer a:hover {
        text-decoration: underline;
      }

      .footer-links {
        display: flex;
        justify-content: center;
        gap: 16px;
        margin-bottom: 8px;
        flex-wrap: wrap;
      }
    </style>
  </head>

  <body>
    <div class="app">
      <div class="card">
        <h1 id="title">Sign in</h1>
        <label class="small">Email</label>
        <input
          id="email"
          type="email"
          placeholder="you@example.com"
          autocomplete="email"
        />
        <label class="small">Password</label>
        <input
          id="password"
          type="password"
          placeholder="password"
          autocomplete="current-password"
        />
        <div id="confirmPasswordDiv" style="display: none">
          <label class="small">Confirm Password</label>
          <input
            id="confirmPassword"
            type="password"
            placeholder="confirm password"
            autocomplete="new-password"
          />
        </div>

        <div class="row">
          <button id="btnSubmit" class="btn primary">Login</button>
          <button id="btnToggle" class="btn ghost">Create Account</button>
          <button id="btnCancel" class="btn">Cancel</button>
        </div>

        <div id="msg" class="note"></div>
        <div id="err" class="error" style="display: none"></div>
      </div>
    </div>
    <script src="/config.js"></script>
    <script type="module">
      import { getCsrfToken as _getCsrfToken } from "/modules/csrf.js";
      window.getCsrfToken = _getCsrfToken;
    </script>
    <script>
      const API_BASE = window.APP_CONFIG.API_BASE;
      console.log(`API_BASE:${API_BASE}`);
      const emailEl = document.getElementById("email");
      const passEl = document.getElementById("password");
      const confirmPassEl = document.getElementById("confirmPassword");
      const confirmPassDiv = document.getElementById("confirmPasswordDiv");
      const titleEl = document.getElementById("title");
      const btnSubmit = document.getElementById("btnSubmit");
      const btnToggle = document.getElementById("btnToggle");
      const msg = document.getElementById("msg");
      const err = document.getElementById("err");

      let isLoginMode = true;

      // CSRF token is provided by modules/csrf.js as window.getCsrfToken

      async function checkAuthAndRedirect() {
        try {
          const res = await fetch(`${API_BASE}/api/me`, {
            credentials: "include",
          });
          if (res.ok) {
            // already signed in
            window.location.href = "index.html";
          }
        } catch (e) {
          // ignore
        }
      }

      async function doLogin() {
        err.style.display = "none";
        msg.textContent = "Signing in...";
        try {
          const token = await getCsrfToken();
          const res = await fetch(`${API_BASE}/api/login`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "CSRF-Token": token,
            },
            credentials: "include",
            body: JSON.stringify({
              email: emailEl.value.trim(),
              password: passEl.value,
            }),
          });
          const json = await res.json().catch(() => ({}));
          if (!res.ok) {
            err.textContent = json.error || "Login failed";
            err.style.display = "";
            msg.textContent = "";
            return;
          }
          // success -> redirect to home
          window.location.href = "index.html";
        } catch (e) {
          err.textContent = "Network error";
          err.style.display = "";
          msg.textContent = "";
        }
      }

      async function doRegister() {
        if (passEl.value !== confirmPassEl.value) {
          err.textContent = "Passwords do not match";
          err.style.display = "";
          msg.textContent = "";
          return;
        }

        // basic email and password validation
        const email = emailEl.value.trim();
        const password = passEl.value;
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          err.textContent = "Invalid email address";
          err.style.display = "";
          msg.textContent = "";
          return;
        }
        if (password.length < 8) {
          err.textContent = "Password must be at least 8 characters";
          err.style.display = "";
          msg.textContent = "";
          return;
        }

        err.style.display = "none";
        msg.textContent = "Creating account...";
        try {
          const token = await getCsrfToken();
          const res = await fetch(`${API_BASE}/api/register`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "CSRF-Token": token,
            },
            credentials: "include",
            body: JSON.stringify({
              email: email,
              password: password,
              confirmPassword: confirmPassEl.value,
            }),
          });
          const json = await res.json().catch(() => ({}));
          if (!res.ok) {
            err.textContent = json.error || "Registration failed";
            err.style.display = "";
            msg.textContent = "";
            return;
          }
          msg.textContent =
            "Account created! Please check your email to verify your account.";
          err.style.display = "none";
          btnSubmit.disabled = true;
          btnToggle.disabled = true;
        } catch (e) {
          err.textContent = "Network error";
          err.style.display = "";
          msg.textContent = "";
        }
      }

      function toggleMode() {
        isLoginMode = !isLoginMode;
        titleEl.textContent = isLoginMode ? "Sign in" : "Create Account";
        btnSubmit.textContent = isLoginMode ? "Login" : "Register";
        btnToggle.textContent = isLoginMode
          ? "Create Account"
          : "Back to Login";
        confirmPassDiv.style.display = isLoginMode ? "none" : "block";
        err.style.display = "none";
        msg.textContent = "";
      }

      btnSubmit.addEventListener("click", () =>
        isLoginMode ? doLogin() : doRegister(),
      );
      btnToggle.addEventListener("click", toggleMode);
      btnCancel.addEventListener("click", () => {
        window.location.href = "index.html";
      });

      // allow pressing Enter in password to submit
      passEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && isLoginMode) doLogin();
      });
      confirmPassEl.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !isLoginMode) doRegister();
      });

      // on load, if already authenticated redirect back
      checkAuthAndRedirect();
    </script>

    <footer>
      <div class="footer-links">
        <a href="/">Home</a>
        <a href="/about.html">About</a>
        <a
          href="https://github.com/marcello-dev/trippino"
          target="_blank"
          rel="noopener"
          >GitHub</a
        >
      </div>
      <div>© 2025 Trippino. Built with ❤️ for travelers.</div>
    </footer>
  </body>
</html>
