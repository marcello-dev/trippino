<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sign in â€” Trippino</title>
  <style>
    :root{ --bg:#f6f8fa; --card:#fff; --muted:#666 }
    body{ font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); margin:0; padding:24px; color:#111 }
    .app{ max-width:480px; margin:40px auto }
    .card{ background:var(--card); padding:18px; border-radius:12px; box-shadow:0 6px 18px rgba(12,18,32,0.06) }
    h1{ margin:0 0 12px 0; font-size:20px }
    .small{ font-size:13px; color:var(--muted) }
    input{ width:100%; box-sizing:border-box; padding:10px 12px; border:1px solid #ddd; border-radius:8px; margin-top:8px }
    .row{ display:flex; gap:8px; margin-top:12px }
    .btn{ padding:8px 12px; border-radius:8px; border:0; cursor:pointer }
    .btn.primary{ background:#2563eb; color:#fff }
    .btn.ghost{ background:transparent; border:1px solid #ddd }
    .note{ margin-top:12px; color:var(--muted); font-size:13px }
    .error{ color:#b91c1c; margin-top:8px }
  </style>
</head>
<body>
  <div class="app">
    <div class="card">
      <h1>Sign in / Register</h1>
      <label class="small">Email</label>
      <input id="email" type="email" placeholder="you@example.com" autocomplete="email" />
      <label class="small">Password</label>
      <input id="password" type="password" placeholder="password" autocomplete="current-password" />

      <div class="row">
        <button id="btnLogin" class="btn primary">Login</button>
        <button id="btnRegister" class="btn ghost">Register</button>
        <button id="btnCancel" class="btn">Cancel</button>
      </div>

      <div id="msg" class="note"></div>
      <div id="err" class="error" style="display:none"></div>
    </div>
  </div>

  <script>
    const API_BASE = 'http://localhost:4000'
    const emailEl = document.getElementById('email')
    const passEl = document.getElementById('password')
    const msg = document.getElementById('msg')
    const err = document.getElementById('err')

    async function checkAuthAndRedirect() {
      try {
        const res = await fetch(`${API_BASE}/api/me`, { credentials: 'include' })
        if (res.ok) {
          // already signed in
          window.location.href = 'index.html'
        }
      } catch (e) {
        // ignore
      }
    }

    async function doLogin() {
      err.style.display = 'none'
      msg.textContent = 'Signing in...'
      try {
        const res = await fetch(`${API_BASE}/api/login`, {
          method: 'POST', 
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include', 
          body: JSON.stringify({ 
            email: emailEl.value.trim(), 
            password: passEl.value 
          })
        })
        const json = await res.json().catch(() => ({}))
        if (!res.ok) {
          err.textContent = json.error || 'Login failed'
          err.style.display = ''
          msg.textContent = ''
          return
        }
        // success -> redirect to home
        window.location.href = 'index.html'
      } catch (e) {
        err.textContent = 'Network error'
        err.style.display = ''
        msg.textContent = ''
      }
    }

    async function doRegister() {
      err.style.display = 'none'
      msg.textContent = 'Registering...'
      try {
        const res = await fetch(`${API_BASE}/api/register`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          credentials: 'include', body: JSON.stringify({ email: emailEl.value.trim(), password: passEl.value })
        })
        const json = await res.json().catch(() => ({}))
        if (!res.ok) {
          err.textContent = json.error || 'Register failed'
          err.style.display = ''
          msg.textContent = ''
          return
        }
        // success -> redirect to home
        window.location.href = 'index.html'
      } catch (e) {
        err.textContent = 'Network error'
        err.style.display = ''
        msg.textContent = ''
      }
    }

    document.getElementById('btnLogin').addEventListener('click', doLogin)
    document.getElementById('btnRegister').addEventListener('click', doRegister)
    document.getElementById('btnCancel').addEventListener('click', () => { window.location.href = 'index.html' })

    // allow pressing Enter in password to submit login
    passEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') doLogin() })

    // on load, if already authenticated redirect back
    checkAuthAndRedirect()
  </script>
</body>
</html>
