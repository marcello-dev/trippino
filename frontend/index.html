<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Trippino</title>
    <style>
        :root {
            --bg: #f6f8fa;
            --card: #fff;
            --muted: #666
        }

        body {
            font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
            background: var(--bg);
            margin: 0;
            padding: 24px;
            color: #111
        }

        .app {
            max-width: 980px;
            margin: 0 auto
        }

        header {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 18px
        }

        h1 {
            font-size: 20px;
            margin: 0
        }

        input[type="text"],
        input[type="number"] {
            padding: 8px 10px;
            border: 1px solid #ddd;
            border-radius: 6px
        }

        .card {
            background: var(--card);
            padding: 14px;
            border-radius: 12px;
            box-shadow: 0 6px 18px rgba(12, 18, 32, 0.06);
            margin-bottom: 12px
        }

        .controls {
            display: flex;
            gap: 8px;
            align-items: center
        }

        .cities {
            margin-top: 12px
        }

        .city {
            display: grid;
            grid-template-columns: 1fr 160px 250px 80px;
            gap: 10px;
            align-items: center;
            padding: 10px;
            border-radius: 8px;
            border: 1px dashed #eee;
            margin-bottom: 8px
        }

        .city .name {
            font-weight: 600
        }

        /* calendar styles */
        .calendar-wrapper {
            margin-top: 12px
        }

        .months {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
            gap: 12px;
            width: 100%;
            box-sizing: border-box;
        }

        .month-card {
            border-radius: 8px;
            border: 1px solid #eee;
            padding: 10px;
            background: var(--card);
            box-sizing: border-box;
            width: 100%;
            /* remove fixed 350px width */
        }


        .month-header {
            font-weight: 700;
            margin-bottom: 6px
        }

        .weekday-row {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            font-size: 12px;
            color: var(--muted);
            text-align: center
        }

        .days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0
        }

        /* each day cell is identical size so bars are visually contiguous */
        .day {
            height: 56px;
            /* fixed height */
            border-radius: 0;
            background: #fff;
            text-align: right;
            padding: 6px;
            font-size: 13px;
            position: relative;
            box-sizing: border-box;
            overflow: visible;
        }

        .day.blank {
            background: transparent
        }

        /* blue bar styles for in-range days */
        /* in-range days no longer color the whole cell; we render thin bars instead */
        .day.in-range {
            color: inherit
        }

        /* round only the ends so consecutive .in-range cells form one contiguous bar */
        .day.range-start {
            border-top-left-radius: 20px;
            border-bottom-left-radius: 20px
        }

        .day.range-end {
            border-top-right-radius: 20px;
            border-bottom-right-radius: 20px
        }

        /* label is absolutely positioned so it won't change cell height */
        /* thin horizontal bar that represents the city range on a day cell */
        .range-seg {
            position: absolute;
            left: 0px;
            right: -2px;
            /* slightly extend to connect with next cell */
            height: 14px;
            background: #2563eb;
            color: #fff;
            font-size: 12px;
            line-height: 14px;
            padding: 0 6px;
            box-sizing: border-box;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
            gap: 6px;
            border-radius: 0;
            /* no rounding in middle segments */
            z-index: 1;
        }

        .range-seg .seg-label {
            font-size: 11px;
            color: #fff;
        }

        .day .date-num {
            z-index: 2
        }

        .range-seg.range-start {
            border-top-left-radius: 10px;
            border-bottom-left-radius: 10px
        }

        .range-seg.range-end {
            border-top-right-radius: 10px;
            border-bottom-right-radius: 10px
        }

        .day .date-num {
            position: absolute;
            right: 6px;
            top: 6px;
            font-size: 12px;
            color: inherit
        }

        .small {
            font-size: 12px;
            color: var(--muted)
        }

        .days-control {
            display: flex;
            gap: 6px;
            align-items: center
        }

        .days-control button {
            width: 30px;
            height: 30px;
            border: none;
            cursor: pointer;
            background: #fff;
            border-radius: 20px;
            transition: background-color 0.2s;
        }

        .days-control button:hover {
            background: #f0f0f0;
        }

        .days-control input {
            width: 60px;
            text-align: center
        }

        .meta {
            font-size: 13px;
            color: var(--muted)
        }

        .topline {
            display: flex;
            justify-content: space-between;
            align-items: center
        }

        .actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            justify-self: end
        }

        .btn {
            padding: 8px 10px;
            border-radius: 8px;
            border: 0;
            cursor: pointer
        }

        .btn.primary {
            background: #2563eb;
            color: white
        }

        .btn.ghost {
            background: transparent;
            border: 1px solid #ddd
        }

        /* sync button states */
        .sync-spinning svg#syncIcon {
            animation: sync-rotate 1s linear infinite;
        }

        .sync-success {
            background: #16a34a !important;
        }

        @keyframes sync-rotate {
            from {
                transform: rotate(0deg)
            }

            to {
                transform: rotate(360deg)
            }
        }

        .total {
            font-weight: 700
        }

        footer.small {
            font-size: 12px;
            color: var(--muted);
            margin-top: 8px
        }

        @media (max-width: 720px) {

            /* GENERAL */
            body {
                overflow-x: hidden;
            }

            /* --- Trip creation bar (top) --- */
            body>.app>div>div[style*="display:flex"] {
                flex-direction: column;
                align-items: stretch;
            }

            body>.app>div>div[style*="display:flex"] input,
            body>.app>div>div[style*="display:flex"] button {
                width: 100%;
                box-sizing: border-box;
            }

            /* --- Trip editor header --- */
            .topline {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .topline>div {
                flex-wrap: wrap;
                width: 100%;
            }

            .topline input[type="text"],
            .topline input[type="date"] {
                width: 100%;
                box-sizing: border-box;
            }

            .topline .actions {
                width: 100%;
                justify-content: space-between;
                flex-wrap: wrap;
            }

            .topline .actions .btn {
                flex: 1;
            }

            /* --- City rows --- */
            .city {
                position: relative;
                display: grid;
                grid-template-columns: 1fr auto;
                gap: 8px;
                padding: 8px;
                cursor: pointer;
            }

            .city.active {
                background: #f6f8fa;
            }

            /* Hide date range on mobile */
            .city > div:nth-child(3) {
                grid-column: 1 / -1;
                font-size: 11px;
            }

            /* Hide action buttons by default and render them as a full-width row below the city */
            .city .actions {
                display: none;
                grid-column: 1 / -1;
                justify-content: flex-end;
                gap: 8px;
                padding-top: 8px;
                margin-top: 6px;
                border-top: 1px solid #f0f0f0;
                background: transparent;
            }

            /* Show actions when city is active (appear as an additional row below the city) */
            .city.active .actions {
                display: flex;
            }

            /* Slightly larger action buttons for touch targets on mobile */
            .city .actions button {
                padding: 6px 8px;
                min-width: 36px;
                height: 36px;
                border-radius: 6px;
            }

            /* Smaller padding for mobile cards */
            .card {
                padding: 10px;
            }
        }
    </style>
</head>

<body>
    <div class="app">
        <header>
            <h1>Trippino</h1>
            <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
                <div id="syncArea">
                    <button id="syncBtn" title="Sync state" class="btn"
                        style="padding:8px;border-radius:999px;width:40px;height:40px;display:inline-flex;align-items:center;justify-content:center">
                        <svg id="syncIcon" width="18" height="18" viewBox="0 0 24 24" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <path d="M21 12a9 9 0 10-3.1 6.4" stroke="#111" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round"></path>
                            <path d="M21 3v6h-6" stroke="#111" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round"></path>
                        </svg>
                        <svg id="syncCheck" width="18" height="18" viewBox="0 0 24 24" fill="none" style="display:none"
                            xmlns="http://www.w3.org/2000/svg">
                            <path d="M20 6L9 17l-5-5" stroke="#fff" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" />
                        </svg>
                    </button>
                </div>
                <div id="authArea"></div>
            </div>
        </header>

        <div>
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
                <input id="newTripName" placeholder="Trip name" style="flex:1;max-width:150px" />
                <input id="newTripStart" type="date" />
                <button id="createTripBtn" class="btn primary">Create trip</button>
            </div>

            <div id="tripsContainer"></div>
            <div id="yearSummary"></div>
        </div>

    </div>

    </div>

    <script>
        // --- Auth config & helpers ---
        const API_BASE = 'http://localhost:4000'
        const authArea = document.getElementById('authArea')

        async function checkAuth() {
            try {
                const res = await fetch(`${API_BASE}/api/me`, { credentials: 'include' })
                if (!res.ok) { setAnonymous(); return null }
                const data = await res.json()
                setAuthenticated(data.user)
                return data.user
            } catch (e) {
                console.warn('auth check failed', e)
                setAnonymous()
                return null
            }
        }

        // fetch saved state from backend for the current user (if any)
        async function fetchBackendState() {
            try {
                const res = await fetch(`${API_BASE}/api/state`, { credentials: 'include' })
                if (!res.ok) return null
                const json = await res.json()
                return json && json.state ? json.state : null
            } catch (e) {
                console.warn('fetch backend state failed', e)
                return null
            }
        }

        // load local state and, if logged in, fetch backend state and pick the most recent
        async function loadAndSyncState() {
            const user = await checkAuth()

            let backendState = null
            if (user) backendState = await fetchBackendState()

            const localState = load()

            function tsOf(s) {
                if (!s) return 0
                const t = s.updatedAt || s.updated_at || null
                return t ? Date.parse(t) : 0
            }

            // Decide which state to use
            if (!backendState && !localState) {
                appState = { trips: [] }
            } else if (!user) {
                // not logged in -> use local only
                appState = localState || { trips: [] }
            } else if (!backendState) {
                // logged in, only local exists -> use local and push to backend
                appState = localState || { trips: [] }
                try {
                    await fetch(`${API_BASE}/api/state`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify({ state: appState }) })
                } catch (e) { console.warn('push local to backend failed', e) }
            } else if ((!localState || !localState.trips || !localState.trips.length) && (backendState.trips && backendState.trips.length)) {
                console.log('local state empty but backend has trips, using backend state')
                appState = backendState
                save(appState)
            } else {
                // both not empty, take backend
                appState = backendState
                save(appState)
            }

            // normalize
            if (!appState.trips) appState.trips = []
            if (!activeTripId && appState.trips.length) {
                activeTripId = appState.trips[0].id
                saveActiveTripId(activeTripId)
            }

            // ensure updatedAt exists
            if (!appState.updatedAt) appState.updatedAt = new Date().toISOString()

            // sync local store
            save(appState)

            // refresh UI
            refreshAll()
            render()
        }

        function setAnonymous() {
            authArea.innerHTML = `
                <button id="goAuthBtn" class="btn primary">Sign in / Register</button>
            `
            document.getElementById('goAuthBtn').addEventListener('click', () => {
                // open the dedicated auth page
                window.location.href = 'auth.html'
            })
        }

        function setAuthenticated(user) {
            authArea.innerHTML = `
                <div style="display:flex;gap:8px;align-items:center">
                    <div class="small">Signed in as <strong>${escapeHtml(user.email)}</strong></div>
                    <button id="logoutBtn" class="btn ghost">Logout</button>
                </div>
            `
            document.getElementById('logoutBtn').addEventListener('click', doLogout)
        }

        async function doRegister() {
            const e = document.getElementById('authEmail').value.trim()
            const p = document.getElementById('authPass').value
            if (!e || !p) return alert('email and password required')
            try {
                const res = await fetch(`${API_BASE}/api/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ email: e, password: p })
                })
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}))
                    return alert(err.error || 'register failed')
                }
                // re-load and sync state after registering
                await loadAndSyncState()
            } catch (e) { console.error(e); alert('register failed') }
        }

        async function doLogin() {
            const e = document.getElementById('authEmail').value.trim()
            const p = document.getElementById('authPass').value
            if (!e || !p) return alert('email and password required')
            try {
                const res = await fetch(`${API_BASE}/api/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ email: e, password: p })
                })
                if (!res.ok) {
                    const err = await res.json().catch(() => ({}))
                    return alert(err.error || 'login failed')
                }
                // re-load and sync state after login
                await loadAndSyncState()
            } catch (e) { console.error(e); alert('login failed') }
        }

        async function doLogout() {
            try {
                await fetch(`${API_BASE}/api/logout`, { method: 'POST', credentials: 'include' })
            } catch (e) { console.warn('logout failed', e) }
            checkAuth()
            localStorage.clear()
            appState = { trips: [] }
            activeTripId = null
            render()
        }

        // check auth and sync state on load
        loadAndSyncState()

        // Close active city when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.city')) {
                document.querySelectorAll('.city.active').forEach(c => 
                    c.classList.remove('active')
                );
            }
        });

        // Sync UI wiring
        const syncBtn = document.getElementById('syncBtn')
        const syncIcon = document.getElementById('syncIcon')
        const syncCheck = document.getElementById('syncCheck')

        function setSyncSpinning(spin) {
            if (spin) {
                syncBtn.classList.add('sync-spinning')
                syncIcon.style.display = ''
                syncCheck.style.display = 'none'
            } else {
                syncBtn.classList.remove('sync-spinning')
            }
        }

        function showSyncSuccessBrief() {
            syncIcon.style.display = 'none'
            syncCheck.style.display = ''
            syncBtn.classList.add('sync-success')
            setTimeout(() => {
                syncCheck.style.display = 'none'
                syncIcon.style.display = ''
                syncBtn.classList.remove('sync-success')
            }, 1100)
        }

        syncBtn.addEventListener('click', async () => {
            try {
                setSyncSpinning(true)
                await loadAndSyncState()
                setSyncSpinning(false)
                showSyncSuccessBrief()
            } catch (e) {
                console.warn('manual sync failed', e)
                setSyncSpinning(false)
            }
        })

        // App model: { trips: [{id,name,start,cities}], updatedAt } (activeTripId stored separately)
        const STORAGE_KEY = 'simpleTripPlanner_v1'

        // DOM - note: global editor elements removed; per-trip editor creates its own DOM
        // central container
        const tripsContainer = document.getElementById('tripsContainer')
        const createTripBtn = document.getElementById('createTripBtn')
        const newTripName = document.getElementById('newTripName')
        const newTripStart = document.getElementById('newTripStart')

        // helpers
        const uid = () => Math.random().toString(36).slice(2, 9)
        const tid = () => 't_' + Math.random().toString(36).slice(2, 9)

    /* Typeahead / suggestions styles */
    const styleEl = document.createElement('style')
    styleEl.textContent = `
    .tt-popup { position: absolute; background: white; border: 1px solid #eee; box-shadow: 0 6px 18px rgba(12,18,32,0.06); border-radius:6px; z-index:1000; width:260px; }
    .tt-popup .tt-item { padding:8px; cursor:pointer; border-bottom:1px solid #f2f4f6 }
    .tt-popup .tt-item:last-child { border-bottom:0 }
    .tt-popup .tt-item:hover { background:#f6f8fa }
    .tt-input-inline { padding:6px 8px; border:1px solid #ddd; border-radius:6px; width:220px }
    `
    document.head.appendChild(styleEl)

        function load() {
            const raw = localStorage.getItem(STORAGE_KEY)
            if (!raw) return { trips: [] }
            try {
                return JSON.parse(raw)
            } catch (e) {
                console.warn('load failed', e);
                return {
                    trips: [],
                    updatedAt: new Date().toISOString()
                }
            }
        }
        function save(appState) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
            saveApi(appState);
        }

        async function saveApi(appState) {
            try {
                await fetch(`${API_BASE}/api/state`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, credentials: 'include', body: JSON.stringify({ state: appState }) })
            } catch (e) { console.warn('push local to backend failed', e) }
        }

        // app state (trips and other data) — activeTripId is stored separately
        const ACTIVE_TRIP_KEY = 'simpleTripPlanner_activeTrip_v1'
        let activeTripId = null

        let appState = load()
        if (!appState.trips) appState.trips = []

        // load activeTripId from separate storage if present, otherwise default to first trip
        function loadActiveTripId() {
            const v = localStorage.getItem(ACTIVE_TRIP_KEY)
            if (v) return v
            if (appState.trips && appState.trips.length) return appState.trips[0].id
            return null
        }
        function saveActiveTripId(id) {
            if (id === null || typeof id === 'undefined') localStorage.removeItem(ACTIVE_TRIP_KEY)
            else localStorage.setItem(ACTIVE_TRIP_KEY, id)
        }

        activeTripId = loadActiveTripId()

        function getActiveTrip() {
            if (!activeTripId) return null
            return appState.trips.find(t => t.id === activeTripId) || null
        }

        function setActiveTrip(id) {
            // do not modify appState — active trip id is stored separately
            activeTripId = id
            saveActiveTripId(id)
            state = getActiveTrip() || { tripName: '', tripStart: '', cities: [] }
            refreshAll()
            render()
        }

        function createTrip(name, start) {
            const t = {
                id: tid(),
                name: name || 'New trip', start: start || '',
                cities: [],
                updatedAt: new Date().toISOString()
            }
            appState.trips.push(t)
            appState.updatedAt = new Date().toISOString();
            setActiveTrip(t.id)
            save(appState)
            refreshAll()
            render()
        }

        function deleteTrip(id) {
            const idx = appState.trips.findIndex(t => t.id === id)
            if (idx === -1) return
            appState.trips.splice(idx, 1)
            appState.updatedAt = new Date().toISOString();
            if (activeTripId === id) setActiveTrip(appState.trips.length ? appState.trips[0].id : null)
            save(appState)
            refreshAll()
            render()
        }

        function updateDays(tripId, cityId, newDays) {
            const t = appState.trips.find(x => x.id === tripId)
            if (!t) return
            const c = t.cities.find(x => x.id === cityId)
            if (!c) return
            c.days = Math.max(1, Number(newDays))
            c.updatedAt = new Date().toISOString()
            // Update store in backend

            save(appState)
            refreshAll()
        }

        function removeCityFromTrip(tripId, cityId) {
            const t = appState.trips.find(x => x.id === tripId)
            if (!t) return
            t.cities = t.cities.filter(c => c.id !== cityId)
            t.updatedAt = new Date().toISOString()
            save(appState)
            refreshAll()
        }

        function updateTripInStore(t) {
            const idx = appState.trips.findIndex(x => x.id === t.id)
            if (idx === -1) return
            appState.trips[idx] = t
            save(appState)
            refreshAll()
        }

        // transient UI set for expanded trip ids (not persisted)
        const expandedTripIds = new Set()

        function renderTripsContainer() {
            // sort by start date desc (most recent first). Empty start goes last.
            const sorted = [...appState.trips].sort((a, b) => {
                if (!a.start && !b.start) return 0
                if (!a.start) return 1
                if (!b.start) return -1
                return b.start.localeCompare(a.start)
            })
            tripsContainer.innerHTML = ''
            for (const t of sorted) {
                const card = document.createElement('div')
                card.className = 'card'
                card.style.marginBottom = '12px'

                const header = document.createElement('div')
                header.style.display = 'flex'
                header.style.justifyContent = 'space-between'
                header.style.alignItems = 'center'
                header.style.cursor = 'pointer'
                header.innerHTML = `
                <div>
                    <strong>${escapeHtml(t.name || 'Untitled')}</strong>
                    <div class="small" style="color:var(--muted)">${t.start || ''}</div>
                </div>
                <div style="display:flex;gap:8px">
                    <button class="btn" data-action="toggle">
                        ${expandedTripIds.has(t.id) ? 'Collapse' : 'Expand'}
                    </button>
                    <button class="btn ghost" data-action="edit" title="Edit trip name" aria-label="Edit trip name">✎</button>
                    <button class="btn ghost" data-action="del" title="Delete trip" aria-label="Delete trip">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" role="img" aria-hidden="true">
                            <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>`
                header.querySelector('[data-action="del"]').addEventListener('click', (e) => { e.stopPropagation(); if (confirm('Delete trip?')) { deleteTrip(t.id); renderTripsContainer() } })
                const editBtn = header.querySelector('[data-action="edit"]')
                if (editBtn) {
                    editBtn.addEventListener('click', (e) => {
                        e.stopPropagation()
                        const n = prompt('Trip name', t.name || '')
                        if (n !== null) {
                            t.name = n
                            updateTripInStore(t)
                            renderTripsContainer()
                        }
                    })
                }
                header.querySelector('[data-action="toggle"]').addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (expandedTripIds.has(t.id)) {
                        expandedTripIds.delete(t.id)
                    } else {
                        expandedTripIds.add(t.id);
                        /* make this trip active for editing */
                        setActiveTrip(t.id)
                    }
                    renderTripsContainer()
                })
                header.addEventListener('click', () => {
                    if (expandedTripIds.has(t.id)) {
                        expandedTripIds.delete(t.id)
                    } else {
                        expandedTripIds.add(t.id);
                        setActiveTrip(t.id)
                    } renderTripsContainer()
                })

                card.appendChild(header)

                if (expandedTripIds.has(t.id)) {
                    const body = document.createElement('div')
                    body.style.marginTop = '10px'
                    // editor area
                    const editorWrap = document.createElement('div')
                    editorWrap.className = 'card'
                    renderTripEditor(t, editorWrap)
                    body.appendChild(editorWrap)
                    // calendar
                    const calWrap = document.createElement('div')
                    calWrap.className = 'card calendar-wrapper'
                    renderTripCalendar(t, calWrap)
                    body.appendChild(calWrap)


                    card.appendChild(body)
                }

                tripsContainer.appendChild(card)
            }
        }

        // render once helper
        function refreshAll() {
            renderTripsContainer()
            renderYearSummary()
        }

        // Render per-year summary of travel days vs days at home.
        function renderYearSummary() {
            const container = document.getElementById('yearSummary')
            if (!container) return
            container.innerHTML = ''
            // gather unique travel dates per year
            const yearMap = new Map() // year -> Set of date strings
            for (const trip of (appState.trips || [])) {
                if (!trip.start) continue
                const totalDays = (trip.cities || []).reduce((s, c) => s + Number(c.days || 0), 0)
                if (totalDays <= 0) continue
                const tripStart = new Date(trip.start)
                for (let i = 0; i < totalDays; i++) {
                    const d = addDays(tripStart, i)
                    const y = d.getFullYear()
                    const key = formatDate(d)
                    if (!yearMap.has(y)) yearMap.set(y, new Set())
                    yearMap.get(y).add(key)
                }
            }

            if (yearMap.size === 0) {
                // nothing to show
                return
            }

            const card = document.createElement('div')
            card.className = 'card'
            const header = document.createElement('div')
            header.style.display = 'flex'
            header.style.justifyContent = 'space-between'
            header.style.alignItems = 'center'
            header.innerHTML = `<div><strong>Year summary</strong><div class="small" style="color:var(--muted)">Travel days vs days at home</div></div>`
            card.appendChild(header)

            const body = document.createElement('div')
            body.style.marginTop = '10px'

            const years = Array.from(yearMap.keys()).sort((a, b) => b - a)
            for (const y of years) {
                const travelSet = yearMap.get(y) || new Set()
                const travelDays = travelSet.size
                const daysInYear = (new Date(y, 11, 31) - new Date(y, 0, 0)) / (24 * 60 * 60 * 1000)
                // daysInYear computed as difference between Dec 31 and Jan 0 gives 365 or 366
                const homeDays = Math.max(0, Math.round(daysInYear) - travelDays)
                const row = document.createElement('div')
                row.style.display = 'flex'
                row.style.justifyContent = 'space-between'
                row.style.alignItems = 'center'
                row.style.padding = '6px 0'
                row.innerHTML = `<div><strong>${y}</strong></div><div class="small">Travel: <strong>${travelDays}</strong> days — Home: <strong>${homeDays}</strong> days</div>`
                body.appendChild(row)
            }

            card.appendChild(body)
            container.appendChild(card)
        }

        // global render shim: sync `state` to active trip and refresh UI
        function render() {
            state = getActiveTrip() || { tripName: '', tripStart: '', cities: [] }
            refreshAll()
        }

        // state (active trip editor state)
        let state = getActiveTrip() || { tripName: '', tripStart: '', cities: [] }


        function addCity(name = 'New city', days = 1) {
            state.cities.push({
                id: uid(),
                name,
                days: Math.max(1, Number(days)),
                updatedAt: new Date().toISOString()
            })
            render()
        }
        function removeCity(id) {
            state.cities = state.cities.filter(c => c.id !== id)
            render()
        }
        function renameCity(id) {
            // keep for UI-driven rename (prompt) but delegate actual update to updateCityName
            const c = state.cities.find(x => x.id === id)
            if (!c) return
            const n = prompt('City name', c.name)
            if (n !== null) updateCityName(id, n)
        }

        // Programmatic updater for a city's name. Validates input and re-renders.
        function updateCityName(id, newName) {
            const c = state.cities.find(x => x.id === id)
            if (!c) return
            if (newName === null || newName === undefined) return
            c.name = String(newName)
            render()
        }
        function changeDays(id, delta) {
            const c = state.cities.find(x => x.id === id)
            if (!c) return
            const newDays = Math.max(1, Number(c.days) + delta)
            c.days = newDays
            render()
        }
        function setDays(id, value) {
            const c = state.cities.find(x => x.id === id)
            if (!c) return
            c.days = Math.max(1, Number(value) || 1)
            render()
        }

        // --- per-trip render helpers for stacked UI ---
        function renderTripEditor(trip, container) {
            container.innerHTML = ''
            // header inputs
            const topline = document.createElement('div')
            topline.className = 'topline'
            topline.innerHTML = `
                <div style="display:flex;gap:8px;align-items:center">
                    <div class="small" style="margin-left:6px;color:var(--muted)">Start date</div>
                    <input class="trip-start" type="date" value="${escapeHtml(trip.start || '')}" />
                </div>
            `
            container.appendChild(topline)

            const citiesContainer = document.createElement('div')
            citiesContainer.className = 'cities'
            container.appendChild(citiesContainer)

            const metaRow = document.createElement('div')
            metaRow.style.display = 'flex'
            metaRow.style.justifyContent = 'space-between'
            metaRow.style.alignItems = 'center'
            metaRow.style.marginTop = '12px'
            metaRow.innerHTML = `<div class="meta">Total nights: <span class="total-days">0</span></div>`
            container.appendChild(metaRow)

            // wire interactions: edit trip name (prompt) and start date
            const nameDisplay = topline.querySelector('.trip-name-display')
            const startInput = topline.querySelector('.trip-start')
            startInput.addEventListener('change', () => { trip.start = startInput.value; updateTripInStore(trip) })

            // render cities list
            function renderCitiesList() {
                citiesContainer.innerHTML = ''
                let dayCursor = 1
                for (let i = 0; i < trip.cities.length; i++) {
                    const c = trip.cities[i]
                    const start = dayCursor
                    const end = dayCursor + Number(c.days)
                    const cityRow = document.createElement('div')
                    cityRow.className = 'city'
                    cityRow.dataset.id = c.id
                    cityRow.innerHTML = `
                        <div>
                            <div class="name">
                                ${escapeHtml(c.name || 'Unnamed city')}
                            </div>
                        </div>
                        <div class="days-control">
                            <button data-action="dec">−</button>
                            <div class="days-display" style="background:white;width:30px;text-align:center;padding:1px 1px;border: none;border-radius:6px">${c.days}</div>
                            <button data-action="inc">+</button>
                        </div>
                        <div class="small">
                                ${formatDate(addDays(new Date(trip.start), start - 1))} (${weekdayName(addDays(new Date(trip.start), start - 1))}) → ${formatDate(addDays(new Date(trip.start), end - 1))} (${weekdayName(addDays(new Date(trip.start), end - 1))})
                        </div>
                        <div class="actions" style="text-align:right">
                            <button data-action="rename" class="btn ghost" title="Rename">✎</button>
                            <button data-action="remove" class="btn" title="Remove city" aria-label="Remove city"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" role="img" aria-hidden="true"><path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></button>
                        </div>
                    `
                    cityRow.querySelector('[data-action="dec"]').addEventListener('click', () => {
                        c.days = Math.max(1, Number(c.days) - 1);
                        updateDays(trip.id, c.id, c.days);
                        renderTripEditor(trip, container)
                    })
                    cityRow.querySelector('[data-action="inc"]').addEventListener('click', () => {
                        c.days = Math.max(1, Number(c.days) + 1);
                        updateDays(trip.id, c.id, c.days);
                        renderTripEditor(trip, container)
                    })
                    // Days input is now read-only, controlled by + and - buttons only
                    cityRow.querySelector('[data-action="remove"]').addEventListener('click', () => {
                        trip.cities = trip.cities.filter(x => x.id !== c.id);
                        removeCityFromTrip(trip.id, c.id);
                        renderTripEditor(trip, container)
                    })
                    cityRow.querySelector('[data-action="rename"]').addEventListener('click', (ev) => {
                        ev.stopPropagation()
                        // open popup anchored to the rename button
                        const renameBtn = ev.currentTarget
                        createCitySearchPopup(renameBtn, async (sel) => {
                            if (!sel) return
                            c.name = sel.name
                            if (sel.position) { c.lat = sel.position.lat; c.lon = sel.position.lon }
                            c.updatedAt = new Date().toISOString()
                            updateTripInStore(trip)
                            renderTripEditor(trip, container)
                        }, c.name)
                    })
                    // Add click handler for mobile action buttons
                    cityRow.addEventListener('click', (e) => {
                        // Don't toggle if clicking a button
                        if (e.target.closest('button')) return;
                        
                        // Remove active class from all other cities
                        citiesContainer.querySelectorAll('.city.active').forEach(c => {
                            if (c !== cityRow) c.classList.remove('active')
                        });
                        // Toggle active state on this city
                        cityRow.classList.toggle('active');
                    });

                    citiesContainer.appendChild(cityRow)
                    dayCursor = end
                }
                // Add the bottom "Add city" button
                const bottomAddBtn = document.createElement('div')
                bottomAddBtn.style.textAlign = 'center'
                bottomAddBtn.style.marginTop = '12px'
                bottomAddBtn.innerHTML = '<button class="btn ghost" style="width:100%">+ Add city</button>'
                bottomAddBtn.querySelector('button').addEventListener('click', (e) => {
                    e.stopPropagation()
                    const popup = createCitySearchPopup(e.target, async (sel) => {
                        if (!sel) return
                        const newCity = { 
                            id: uid(), 
                            name: sel.name, 
                            days: 1,
                            updatedAt: new Date().toISOString()
                        }
                        trip.cities.push(newCity)
                        updateTripInStore(trip)
                        renderTripEditor(trip, container)
                    })
                })
                citiesContainer.appendChild(bottomAddBtn)

                // update total days
                const total = trip.cities.reduce((s, c) => s + Number(c.days), 0)
                const totalDaysEl = container.querySelector('.total-days')
                if (totalDaysEl) totalDaysEl.textContent = total
            }

            renderCitiesList()
        }

        function renderTripCalendar(trip, container) {
            container.innerHTML = '<h3 style="margin:0 0 8px 0">Calendar view</h3>'
            const hint = document.createElement('div')
            hint.className = 'small'
            hint.textContent = 'Set a trip start date to see the calendar.'
            container.appendChild(hint)
            const months = document.createElement('div')
            months.className = 'months'
            container.appendChild(months)

            if (!trip.start || trip.cities.length === 0) { hint.style.display = 'block'; return }
            hint.style.display = 'none'

            let cur = 1
            const cityRanges = trip.cities.map(c => { const s = cur; const e = cur + Number(c.days); cur = e; return { id: c.id, name: c.name || 'Unnamed', start: s, end: e } })
            const tripStart = new Date(trip.start)
            const totalDays = cityRanges.length ? cityRanges[cityRanges.length - 1].end : 0
            if (totalDays <= 0) return

            const tripFirstDate = addDays(tripStart, 0)
            const tripLastDate = addDays(tripStart, totalDays - 1)
            const shownMonths = []
            const m = new Date(tripFirstDate.getFullYear(), tripFirstDate.getMonth(), 1)
            while (m <= tripLastDate) { shownMonths.push(new Date(m)); m.setMonth(m.getMonth() + 1) }

            const weekdays = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']
            for (const monthStart of shownMonths) {
                const monthCard = document.createElement('div')
                monthCard.className = 'month-card'
                const monthLabel = monthStart.toLocaleString(undefined, { month: 'long', year: 'numeric' })
                const header = document.createElement('div')
                header.className = 'month-header'
                header.textContent = monthLabel
                monthCard.appendChild(header)
                const wk = document.createElement('div')
                wk.className = 'weekday-row'
                wk.innerHTML = weekdays.map(w => `<div>${w}</div>`).join('')
                monthCard.appendChild(wk)
                const daysGrid = document.createElement('div')
                daysGrid.className = 'days-grid'
                const firstOfMonth = new Date(monthStart.getFullYear(), monthStart.getMonth(), 1)
                let weekday = firstOfMonth.getDay()
                let blanks = (weekday === 0) ? 6 : (weekday - 1)
                for (let i = 0; i < blanks; i++) { const b = document.createElement('div'); b.className = 'day blank'; daysGrid.appendChild(b) }
                const daysInMonth = new Date(monthStart.getFullYear(), monthStart.getMonth() + 1, 0).getDate()
                for (let d = 1; d <= daysInMonth; d++) {
                    const date = new Date(monthStart.getFullYear(), monthStart.getMonth(), d)
                    // compute day difference using UTC midnight to avoid timezone shifts
                    const msPerDay = 24 * 60 * 60 * 1000
                    const absDay = Math.floor((Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()) - Date.UTC(tripStart.getFullYear(), tripStart.getMonth(), tripStart.getDate())) / msPerDay) + 1
                    const dayEl = document.createElement('div')
                    dayEl.className = 'day'
                    dayEl.innerHTML = `<div class="date-num">${d}</div>`
                    if (absDay >= 1 && absDay <= totalDays) {
                        const matches = cityRanges.filter(r => absDay >= r.start && absDay <= r.end)
                        if (matches.length) {
                            dayEl.classList.add('in-range')
                            // render contiguous thin segments per city across their range.
                            // position (vertical layer) alternates by city index so adjacent cities don't overlap.
                            const topBase = 26 // px, below date number
                            const step = 16 // px between two alternating layers
                            for (const cr of matches) {
                                const seg = document.createElement('div')
                                seg.className = 'range-seg'
                                // determine layer by the city's index in cityRanges (alternating 0/1)
                                const idxAll = cityRanges.findIndex(r => r.id === cr.id)
                                const layer = idxAll % 2
                                seg.style.top = `${topBase + layer * step}px`
                                if (absDay === cr.start) seg.classList.add('range-start')
                                if (absDay === cr.end) seg.classList.add('range-end')
                                // only show the name label at the beginning of the city's bar
                                if (absDay === cr.start) {
                                    const segLabel = document.createElement('div')
                                    segLabel.className = 'seg-label'
                                    segLabel.textContent = cr.name
                                    seg.appendChild(segLabel)
                                }
                                dayEl.appendChild(seg)
                            }
                        }
                    } else {
                        dayEl.classList.add('blank')
                    }
                    daysGrid.appendChild(dayEl)
                }
                monthCard.appendChild(daysGrid)
                months.appendChild(monthCard)
            }
        }

        // utility date functions
        function addDays(d, n) { const t = new Date(d); t.setDate(t.getDate() + n); return t }
        function formatDate(d) { return d.toISOString().slice(0, 10) }
        function weekdayName(d) { return ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'][d.getDay()] }

        // ---------- TomTom typeahead popup helper ----------
        function createCitySearchPopup(anchorEl, onSelect, initialValue = '') {
            // anchorEl: DOM node to position under, onSelect: callback(selObject|null)
            // returns the popup element
            const popup = document.createElement('div')
            popup.className = 'tt-popup'
            popup.style.minWidth = '260px'
            popup.style.padding = '8px'
            // input
            const input = document.createElement('input')
            input.className = 'tt-input-inline'
            input.value = initialValue || ''
            popup.appendChild(input)
            const list = document.createElement('div')
            list.style.maxHeight = '260px'
            list.style.overflow = 'auto'
            list.style.marginTop = '6px'
            popup.appendChild(list)

            // position popup
            document.body.appendChild(popup)
            const rect = anchorEl.getBoundingClientRect()
            popup.style.position = 'absolute'
            popup.style.left = `${rect.left}px`
            popup.style.top = `${rect.bottom + window.scrollY + 6}px`

            let debounceTimer = null
            let lastQuery = ''

            async function doQuery(q) {
                if (!q) {
                    renderList([])
                    return
                }
                try {
                    const url = `${API_BASE}/api/tomtom?q=${encodeURIComponent(q)}&limit=6&typeahead=true`
                    const res = await fetch(url, { credentials: 'include' })
                    console.log('TomTom proxy query response', url, res.status)
                    if (!res.ok) { renderList([]); return }
                    const json = await res.json()
                    const suggestions = (json.results || []).map(r => ({ 
                        name: `${r.address.freeformAddress}, ${r.address.countryCode || ''}`.trim()
                    }))
                    renderList(suggestions)
                } catch (e) { console.warn('TomTom proxy query failed', e); renderList([]) }
            }

            function renderList(items) {
                list.innerHTML = ''
                if (!items.length) {
                    const none = document.createElement('div')
                    none.className = 'tt-item'
                    none.textContent = 'No suggestions'
                    list.appendChild(none)
                    return
                }
                for (const it of items) {
                    const el = document.createElement('div')
                    el.className = 'tt-item'
                    el.textContent = it.name || 'Unknown'
                    el.addEventListener('click', () => {
                        cleanup()
                        onSelect(it)
                    })
                    list.appendChild(el)
                }
            }

            function cleanup() {
                if (debounceTimer) clearTimeout(debounceTimer)
                if (popup && popup.parentNode) popup.parentNode.removeChild(popup)
                document.removeEventListener('mousedown', docMouse)
            }

            function docMouse(e) {
                if (!popup.contains(e.target) && !anchorEl.contains(e.target)) {
                    cleanup()
                    onSelect(null)
                }
            }

            input.addEventListener('input', (ev) => {
                const q = ev.target.value.trim()
                lastQuery = q
                if (debounceTimer) clearTimeout(debounceTimer)
                debounceTimer = setTimeout(() => doQuery(q), 300)
            })

            // handle keyboard selection: Enter selects first item
            input.addEventListener('keydown', (ev) => {
                if (ev.key === 'Enter') {
                    const first = list.querySelector('.tt-item')
                    if (first) {
                        first.click()
                    }
                } else if (ev.key === 'Escape') {
                    cleanup(); onSelect(null)
                }
            })

            document.addEventListener('mousedown', docMouse)

            // initial query if value provided
            if (input.value && input.value.length >= 2) {
                doQuery(input.value)
            }

            input.focus()
            return popup
        }

        // escape for safety (we control the HTML but keep it safe)
        function escapeHtml(s) { return String(s).replace(/[&<>"']/g, function (ch) { return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": "&#39;" }[ch] }) }

        // top-level interactions are handled per-trip now

        createTripBtn.addEventListener('click', () => {
            createTrip(newTripName.value || 'New trip', newTripStart.value || '')
            newTripName.value = ''
            newTripStart.value = ''
        })

        // initial render
        refreshAll()
        render()

    </script>
</body>

</html>